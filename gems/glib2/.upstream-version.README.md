# Upstream Version Tracking

This file (`.upstream-version`) tracks which version of the glib2 gem from rubygems.org our binary gem modifications are based on.

## Why This Exists

We maintain a binary gem version of glib2 with specific modifications:
- Platform targeting (`x64-mingw32`)
- Precompiled native extensions (`.so` files)
- Bundled vendor DLLs
- Modified loader for version-specific `.so` selection

When ruby-gnome releases a new version (e.g., 4.3.4 → 4.3.5), we need to:
1. **Review changes** to ensure our modifications remain compatible
2. **Re-apply** our binary gem modifications to the new upstream source
3. **Test** that the new version works with our modifications

## Automated Version Check

The build workflow (`.github/workflows/build-windows-x64.yml`) automatically:
1. Reads `.upstream-version` to know what version we're based on
2. Queries rubygems.org API for the latest released version
3. **Fails the build** if versions don't match

This prevents accidentally building from outdated source with potential bugs or security issues.

## Updating to a New Upstream Version

When rubygems.org releases a new version (e.g., 4.3.5):

### 1. Download and unpack new version
```bash
gem fetch glib2 --version 4.3.5
gem unpack glib2-4.3.5.gem
```

### 2. Review changes
```bash
diff -r gems/glib2 glib2-4.3.5
```

Look for changes that might affect our modifications:
- Changes to `lib/glib2.rb` (we modify this for binary gem loading)
- Changes to `glib2.gemspec` (we modify this for platform/files)
- New dependencies or requirements
- API changes that affect our build process

### 3. Apply our binary gem modifications

Copy new upstream source:
```bash
cp -r glib2-4.3.5/* gems/glib2/
```

Then restore our modifications:
```bash
# Restore our modified gemspec
git checkout gems/glib2/glib2.gemspec

# Restore our modified loader
git checkout gems/glib2/lib/glib2.rb

# Review if upstream changes require updating our mods
git diff HEAD gems/glib2/
```

### 4. Update version tracker
```bash
echo "4.3.5" > gems/glib2/.upstream-version
```

### 5. Test locally
```bash
bundle install
bundle exec rake test:glib2
```

### 6. Commit
```bash
git add gems/glib2/
git commit -m "chore(glib2): update to upstream 4.3.5

- Updated from glib2 4.3.4 → 4.3.5
- Re-applied binary gem modifications
- Verified compatibility with our build process"
```

## Override for Testing

To test a pre-release or forked version:

1. Update `.upstream-version` to match your test version
2. Replace source files in `gems/glib2/`
3. Re-apply binary gem modifications
4. Build will succeed if `.upstream-version` matches your intent

**Important:** Don't merge test versions to main branch. Only use official rubygems.org releases for production.

## Source of Truth

**rubygems.org** is the canonical source for gem versions because:
- All GTK3 suite gems (glib2, gtk3, pango, atk) released together at same version
- Stable, tested releases (not bleeding-edge development)
- Guaranteed compatibility across the suite
- Same source users get with `gem install glib2`
