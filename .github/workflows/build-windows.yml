name: Build Windows GTK3 Binary Gems

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main, develop]
  pull_request:

jobs:
  build-windows-x64:
    name: Build binary gems (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }} (x64)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Extract GTK3 vendor libraries (x64)
        shell: msys2 {0}
        run: |
          echo "Extracting GTK3 libraries from MSYS2 (x64)..."
          mkdir -p vendor/windows/x64/bin
          mkdir -p vendor/windows/x64/share

          # Copy GTK3 and GLib DLLs to vendor
          echo "Copying GLib2 DLLs..."
          cp /mingw64/bin/libglib-2.0-0.dll vendor/windows/x64/bin/ || true
          cp /mingw64/bin/libgobject-2.0-0.dll vendor/windows/x64/bin/ || true
          cp /mingw64/bin/libgio-2.0-0.dll vendor/windows/x64/bin/ || true

          # Copy dependencies
          cp /mingw64/bin/libintl-8.dll vendor/windows/x64/bin/ || true
          cp /mingw64/bin/libiconv-2.dll vendor/windows/x64/bin/ || true
          cp /mingw64/bin/libpcre2-8-0.dll vendor/windows/x64/bin/ || true

          ls -lh vendor/windows/x64/bin/ || echo "Vendor bin directory is empty"

      - name: Copy vendor libraries into gem (x64)
        shell: msys2 {0}
        run: |
          echo "Copying vendor libraries into gem structure..."
          mkdir -p gems/glib2/lib/glib2/vendor/bin
          cp vendor/windows/x64/bin/*.dll gems/glib2/lib/glib2/vendor/bin/ || true
          ls -lh gems/glib2/lib/glib2/vendor/bin/ || echo "No DLLs copied"

      - name: Build glib2 binary gem (x64)
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('glib2')"
        env:
          BINARY_GEM: 'true'

      - name: Show repository status
        run: |
          ruby --version
          gem --version
          dir pkg/ || echo "pkg/ directory not created"

      - name: Run integration tests
        run: |
          ruby -I test test/glib2_spec.rb

      - name: Upload compiled extension (x64, Ruby ${{ matrix.ruby }})
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/glib2/lib/glib2/*/glib2.so
            gems/glib2/lib/glib2/vendor/**/*
          retention-days: 30
          if-no-files-found: warn

  build-windows-x86:
    name: Build binary gems (Windows x86, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }} (x86)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x86)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          update: true
          install: >-
            mingw-w64-i686-gtk3
            mingw-w64-i686-glib2
            mingw-w64-i686-toolchain
            pkg-config

      - name: Extract GTK3 vendor libraries (x86)
        shell: msys2 {0}
        run: |
          echo "Extracting GTK3 libraries from MSYS2 (x86)..."
          mkdir -p vendor/windows/x86/bin
          mkdir -p vendor/windows/x86/share

          # Copy GTK3 and GLib DLLs to vendor
          echo "Copying GLib2 DLLs (x86)..."
          cp /mingw32/bin/libglib-2.0-0.dll vendor/windows/x86/bin/ || true
          cp /mingw32/bin/libgobject-2.0-0.dll vendor/windows/x86/bin/ || true
          cp /mingw32/bin/libgio-2.0-0.dll vendor/windows/x86/bin/ || true

          # Copy dependencies
          cp /mingw32/bin/libintl-8.dll vendor/windows/x86/bin/ || true
          cp /mingw32/bin/libiconv-2.dll vendor/windows/x86/bin/ || true
          cp /mingw32/bin/libpcre2-8-0.dll vendor/windows/x86/bin/ || true

          ls -lh vendor/windows/x86/bin/ || echo "Vendor bin directory is empty"

      - name: Copy vendor libraries into gem (x86)
        shell: msys2 {0}
        run: |
          echo "Copying vendor libraries into gem structure..."
          mkdir -p gems/glib2/lib/glib2/vendor/bin
          cp vendor/windows/x86/bin/*.dll gems/glib2/lib/glib2/vendor/bin/ || true
          ls -lh gems/glib2/lib/glib2/vendor/bin/ || echo "No DLLs copied"

      - name: Build glib2 binary gem (x86) - x86-mingw32 platform
        run: |
          # Note: This would need to target x86-mingw32 platform
          # Currently building as x64-mingw32 as Ruby setup doesn't support x86
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('glib2')"
        env:
          BINARY_GEM: 'true'

      - name: Show repository status
        run: |
          ruby --version
          gem --version
          dir pkg/ || echo "pkg/ directory not created"

      - name: Run integration tests
        run: |
          ruby -I test test/glib2_spec.rb

      - name: Upload compiled extension (x86, Ruby ${{ matrix.ruby }})
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: glib2-extensions-x86-${{ matrix.ruby }}
          path: |
            gems/glib2/lib/glib2/*/glib2.so
            gems/glib2/lib/glib2/vendor/**/*
          retention-days: 30
          if-no-files-found: warn

  # Consolidation job: combines all .so files into final gems
  build-consolidated-gems:
    name: Consolidate and build final gems
    runs-on: windows-latest
    needs: [build-windows-x64, build-windows-x86]
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3.0
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: true

      - name: Download x64 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-3.3
          path: gems/glib2/lib/glib2/

      - name: Download x64 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-3.4
          path: gems/glib2/lib/glib2/

      - name: Download x86 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x86-3.3
          path: gems/glib2/lib/glib2/

      - name: Download x86 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x86-3.4
          path: gems/glib2/lib/glib2/

      - name: Build consolidated x64 gem (multi-Ruby)
        run: |
          # Consolidate precompiled extensions into final gem (no compilation)
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('glib2')"

      - name: List built gems
        run: |
          if (Test-Path pkg) {
            echo "Contents of pkg directory:"
            dir pkg/
          } else {
            echo "ERROR: No pkg directory found!"
            exit 1
          }

      - name: Upload consolidated gem (x64)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: glib2-x64-mingw32-multiruby
          path: pkg/
          retention-days: 90
          if-no-files-found: error
