# Build Windows x64 GTK3 Suite Binary Gems Workflow
#
# Purpose:
#   Compiles complete GTK3 suite (9 gems) for Windows x64 across multiple Ruby versions
#   using dependency-aware DLL bundling strategy matching official ruby-gnome architecture.
#
# Architecture:
#   Sequential gem jobs, each with:
#   - Build job: Matrix parallel builds for Ruby 3.3, 3.4, 4.0
#   - Consolidate job: Combines into single multi-Ruby gem
#   - Dependency chain enforced via needs: [previous-gem-consolidate]
#
# Gem Build Order:
#   glib2 → gobject-introspection → gio2 → cairo → cairo-gobject → pango → gdk_pixbuf2 → atk → gdk3 → gtk3
#
# DLL Bundling Strategy:
#   - glib2: comprehensive foundation (22+ DLLs) in vendor/local/bin
#   - Other gems: dependency-aware (only gem-specific DLLs, no duplication)
#   - scripts/extract-dll-dependencies.rb scans runtime deps to avoid duplication
#
# See: docs/adr/0001-binary-gem-upstream-modifications.md

name: Build GTK3 Suite (x64)

on:
  workflow_dispatch:

jobs:
  # ============================================================================
  # GLIB2 - Foundation gem
  # ============================================================================

  build-glib2-x64:
    name: Build glib2 (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Build glib2
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('glib2')"
        env:
          BINARY_GEM: 'true'

      - name: Verify glib-enum-types.h was generated
        shell: msys2 {0}
        run: |
          echo "Checking for generated glib-enum-types files..."
          if [ -f gems/glib2/ext/glib2/glib-enum-types.h ]; then
            echo "✓ glib-enum-types.h generated ($(stat -c%s gems/glib2/ext/glib2/glib-enum-types.h) bytes)"
            ls -la gems/glib2/ext/glib2/glib-enum-types.*
          else
            echo "✗ glib-enum-types.h NOT generated - searching..."
            find . -name "glib-enum-types.*" -type f
            exit 1
          fi

      # Bundle foundation DLLs from MSYS2 - glib2 is the base gem that provides core GTK3 runtime
      # All other gems depend on these DLLs being available via glib2's vendor/local/bin
      - name: Bundle foundation DLLs
        shell: msys2 {0}
        run: |
          echo "Bundling foundation DLLs from MSYS2..."
          mkdir -p gems/glib2/vendor/local/bin
          DLL_SRC="/mingw64/bin"
          DLL_DST="gems/glib2/vendor/local/bin"
          # Core GLib/GObject/GIO DLLs
          for dll in \
            libglib-2.0-0.dll \
            libgobject-2.0-0.dll \
            libgio-2.0-0.dll \
            libgmodule-2.0-0.dll \
            libgthread-2.0-0.dll \
            libgirepository-1.0-1.dll \
            libffi-8.dll \
            libintl-8.dll \
            libiconv-2.dll \
            libpcre2-8-0.dll \
            libwinpthread-1.dll \
            zlib1.dll \
            libgcc_s_seh-1.dll \
            libstdc++-6.dll \
            libbz2-1.dll \
            liblzma-5.dll \
            libzstd.dll \
            libexpat-1.dll \
            libbrotlidec.dll \
            libbrotlicommon.dll
          do
            if [ -f "$DLL_SRC/$dll" ]; then
              cp "$DLL_SRC/$dll" "$DLL_DST/"
              echo "  ✓ $dll"
            else
              echo "  ⚠ $dll not found"
            fi
          done
          echo "Bundled $(ls -1 "$DLL_DST"/*.dll 2>/dev/null | wc -l) foundation DLLs"

      - name: Upload glib2 extensions
        uses: actions/upload-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/glib2/lib/
            gems/glib2/vendor/
            gems/glib2/ext/
          retention-days: 30

  consolidate-glib2:
    name: Consolidate glib2 (x64)
    runs-on: windows-latest
    needs: [build-glib2-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download glib2 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-3.3
          path: gems/glib2/

      - name: Download glib2 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-3.4
          path: gems/glib2/

      - name: Download glib2 extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-4.0
          path: gems/glib2/

      - name: Build consolidated glib2 gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('glib2')"

      - name: Upload glib2 gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-glib2-x64-mingw32
          path: pkg/glib2-*.gem
          retention-days: 90

  # ============================================================================
  # GOBJECT-INTROSPECTION - Depends on glib2
  # ============================================================================

  build-gobject-introspection-x64:
    name: Build gobject-introspection (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-glib2]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download glib2 gem
        uses: actions/download-artifact@v4
        with:
          name: gem-glib2-x64-mingw32
          path: deps/

      - name: Download glib2 ext headers (Ruby ${{ matrix.ruby }})
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Copy glib2.so to expected location
        shell: msys2 {0}
        run: |
          echo "Copying glib2.so from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/ || {
            echo "Failed to copy glib2.so, checking what exists:"
            find gems/glib2 -name "*.so"
            exit 1
          }
          ls -la gems/glib2/ext/glib2/glib2.so

      - name: Install glib2 dependency
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem

      # Debug step to verify headers available in workspace
      # Review periodically to determine if still needed after builds stabilize
      - name: Debug - Check glib2 artifacts in workspace
        continue-on-error: true
        shell: msys2 {0}
        run: |
          echo "=== Checking workspace artifacts ==="
          if [ -f "gems/glib2/ext/glib2/glib-enum-types.h" ]; then
            echo "✓ glib-enum-types.h found in workspace"
          else
            echo "✗ glib-enum-types.h MISSING from workspace"
            exit 1
          fi
          if [ -f "gems/glib2/ext/glib2/glib2.so" ]; then
            echo "✓ glib2.so found at expected location"
          else
            echo "✗ glib2.so MISSING from expected location"
            exit 1
          fi

      - name: Build gobject-introspection
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('gobject-introspection')"
        env:
          BINARY_GEM: 'true'

      # Bundle typelib files for GObject Introspection runtime
      # GI-based gems (atk, gdk_pixbuf2, gdk3, gtk3) need these at runtime to generate bindings.
      # Without typelibs, require 'gtk3' fails with TypelibNotFound error.
      # We bundle ALL needed typelibs here since gobject-introspection registers the search path.
      - name: Bundle typelib files
        shell: msys2 {0}
        run: |
          echo "Bundling typelib files from MSYS2..."
          mkdir -p gems/gobject-introspection/vendor/local/lib/girepository-1.0
          # Copy all GTK3 suite typelibs - GI needs these at runtime
          TYPELIB_SRC="/mingw64/lib/girepository-1.0"
          TYPELIB_DST="gems/gobject-introspection/vendor/local/lib/girepository-1.0"
          for typelib in \
            GLib-2.0.typelib \
            GObject-2.0.typelib \
            Gio-2.0.typelib \
            GModule-2.0.typelib \
            GIRepository-2.0.typelib \
            Atk-1.0.typelib \
            GdkPixbuf-2.0.typelib \
            Pango-1.0.typelib \
            PangoCairo-1.0.typelib \
            PangoFT2-1.0.typelib \
            PangoFc-1.0.typelib \
            fontconfig-2.0.typelib \
            cairo-1.0.typelib \
            freetype2-2.0.typelib \
            HarfBuzz-0.0.typelib \
            Gdk-3.0.typelib \
            Gtk-3.0.typelib \
            xlib-2.0.typelib \
            win32-1.0.typelib
          do
            if [ -f "$TYPELIB_SRC/$typelib" ]; then
              cp "$TYPELIB_SRC/$typelib" "$TYPELIB_DST/"
              echo "  ✓ $typelib"
            else
              echo "  ⚠ $typelib not found (may not be needed)"
            fi
          done
          echo "Bundled $(ls -1 "$TYPELIB_DST" | wc -l) typelib files"
          ls -la "$TYPELIB_DST/"

      # Bundle DLLs that typelibs reference when GI loads namespaces
      # Each typelib references a shared library - GI calls dlopen() on these at runtime.
      # Without these DLLs, require 'gtk3' fails with "Failed to load shared library" error.
      - name: Bundle GI runtime DLLs
        shell: msys2 {0}
        run: |
          echo "Bundling GI runtime DLLs from MSYS2..."
          mkdir -p gems/gobject-introspection/vendor/local/bin
          DLL_SRC="/mingw64/bin"
          DLL_DST="gems/gobject-introspection/vendor/local/bin"
          # DLLs corresponding to bundled typelibs (typelib → shared library mapping)
          for dll in \
            libatk-1.0-0.dll \
            libgdk_pixbuf-2.0-0.dll \
            libpango-1.0-0.dll \
            libpangocairo-1.0-0.dll \
            libpangoft2-1.0-0.dll \
            libpangowin32-1.0-0.dll \
            libgdk-3-0.dll \
            libgtk-3-0.dll \
            libcairo-2.dll \
            libcairo-gobject-2.dll \
            libharfbuzz-0.dll \
            libharfbuzz-gobject-0.dll \
            libfreetype-6.dll \
            libfontconfig-1.dll \
            libpixman-1-0.dll \
            libpng16-16.dll \
            libjpeg-8.dll \
            libtiff-6.dll \
            libepoxy-0.dll \
            libfribidi-0.dll \
            libthai-0.dll \
            libdatrie-1.dll \
            librsvg-2-2.dll \
            libxml2-2.dll
          do
            if [ -f "$DLL_SRC/$dll" ]; then
              cp "$DLL_SRC/$dll" "$DLL_DST/"
              echo "  ✓ $dll"
            else
              echo "  ⚠ $dll not found (may not be needed)"
            fi
          done
          echo "Bundled $(ls -1 "$DLL_DST"/*.dll 2>/dev/null | wc -l) DLL files"

      - name: Upload gobject-introspection extensions
        uses: actions/upload-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/gobject-introspection/lib/
            gems/gobject-introspection/vendor/
            gems/gobject-introspection/ext/
          retention-days: 30

  consolidate-gobject-introspection:
    name: Consolidate gobject-introspection (x64)
    runs-on: windows-latest
    needs: [build-gobject-introspection-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download gobject-introspection extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-3.3
          path: gems/gobject-introspection/

      - name: Download gobject-introspection extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-3.4
          path: gems/gobject-introspection/

      - name: Download gobject-introspection extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-4.0
          path: gems/gobject-introspection/

      - name: Build consolidated gobject-introspection gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('gobject-introspection')"

      - name: Upload gobject-introspection gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-gobject-introspection-x64-mingw32
          path: pkg/gobject-introspection-*.gem
          retention-days: 90

  # ============================================================================
  # GIO2 - Depends on gobject-introspection
  # ============================================================================

  build-gio2-x64:
    name: Build gio2 (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-gobject-introspection]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      # (pattern download with path: . loses the gems/ prefix due to LCA behavior)
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          # glib2.so (no naming change needed)
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem

      - name: Build gio2
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('gio2')"
        env:
          BINARY_GEM: 'true'

      - name: Upload gio2 extensions
        uses: actions/upload-artifact@v4
        with:
          name: gio2-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/gio2/lib/
            gems/gio2/vendor/
            gems/gio2/ext/
          retention-days: 30

  consolidate-gio2:
    name: Consolidate gio2 (x64)
    runs-on: windows-latest
    needs: [build-gio2-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download gio2 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: gio2-extensions-x64-3.3
          path: gems/gio2/

      - name: Download gio2 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: gio2-extensions-x64-3.4
          path: gems/gio2/

      - name: Download gio2 extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: gio2-extensions-x64-4.0
          path: gems/gio2/

      - name: Build consolidated gio2 gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('gio2')"

      - name: Upload gio2 gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-gio2-x64-mingw32
          path: pkg/gio2-*.gem
          retention-days: 90

  # ============================================================================
  # CAIRO - Independent gem (different versioning)
  # ============================================================================

  build-cairo-x64:
    name: Build cairo (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-glib2]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download glib2 gem
        uses: actions/download-artifact@v4
        with:
          name: gem-glib2-x64-mingw32
          path: deps/

      - name: Download glib2 ext headers (Ruby ${{ matrix.ruby }})
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Copy glib2.so to expected location
        shell: msys2 {0}
        run: |
          echo "Copying glib2.so from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          ls -la gems/glib2/ext/glib2/glib2.so

      - name: Install glib2 dependency
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem

      - name: Build cairo
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('cairo')"
        env:
          BINARY_GEM: 'true'

      - name: Upload cairo extensions
        uses: actions/upload-artifact@v4
        with:
          name: cairo-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/cairo/lib/
            gems/cairo/vendor/
            gems/cairo/ext/
          retention-days: 30

  consolidate-cairo:
    name: Consolidate cairo (x64)
    runs-on: windows-latest
    needs: [build-cairo-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download cairo extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-3.3
          path: gems/cairo/

      - name: Download cairo extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-3.4
          path: gems/cairo/

      - name: Download cairo extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-4.0
          path: gems/cairo/

      - name: Build consolidated cairo gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('cairo')"

      - name: Upload cairo gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-cairo-x64-mingw32
          path: pkg/cairo-*.gem
          retention-days: 90

  # ============================================================================
  # CAIRO-GOBJECT - Depends on cairo + glib2
  # ============================================================================

  build-cairo-gobject-x64:
    name: Build cairo-gobject (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-cairo]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download cairo ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo

      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          mkdir -p gems/cairo/ext/cairo
          cp gems/cairo/lib/cairo/*/cairo.so gems/cairo/ext/cairo/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/cairo-*.gem

      - name: Build cairo-gobject
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('cairo-gobject')"
        env:
          BINARY_GEM: 'true'

      - name: Upload cairo-gobject extensions
        uses: actions/upload-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/cairo-gobject/lib/
            gems/cairo-gobject/vendor/
            gems/cairo-gobject/ext/
          retention-days: 30

  consolidate-cairo-gobject:
    name: Consolidate cairo-gobject (x64)
    runs-on: windows-latest
    needs: [build-cairo-gobject-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download cairo-gobject extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-3.3
          path: gems/cairo-gobject/

      - name: Download cairo-gobject extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-3.4
          path: gems/cairo-gobject/

      - name: Download cairo-gobject extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-4.0
          path: gems/cairo-gobject/

      - name: Build consolidated cairo-gobject gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('cairo-gobject')"

      - name: Upload cairo-gobject gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-cairo-gobject-x64-mingw32
          path: pkg/cairo-gobject-*.gem
          retention-days: 90

  # ============================================================================
  # PANGO - Depends on cairo + glib2
  # ============================================================================

  build-pango-x64:
    name: Build pango (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-cairo-gobject]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download cairo ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo

      - name: Download cairo-gobject ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo-gobject

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          mkdir -p gems/cairo/ext/cairo
          cp gems/cairo/lib/cairo/*/cairo.so gems/cairo/ext/cairo/
          # cairo_gobject.so (hyphen→underscore in .so name)
          mkdir -p gems/cairo-gobject/ext/cairo-gobject
          cp gems/cairo-gobject/lib/cairo-gobject/*/cairo_gobject.so gems/cairo-gobject/ext/cairo-gobject/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/

      # Create rcairo directory for check_cairo function in mkmf-gnome.rb
      # The check_cairo helper looks for cairo at top_dir/../rcairo/ (sibling dir)
      # but our structure has gems/cairo/. Use copy (not symlink) because Windows
      # native linker (ld.exe) doesn't follow MSYS2 symlinks.
      - name: Create rcairo copy for cairo headers and linking
        shell: msys2 {0}
        run: |
          echo "Creating rcairo copy for check_cairo and Windows linker..."
          cp -r gems/cairo rcairo
          ls -la rcairo/ext/cairo/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem
          gem install deps/cairo-*.gem
          gem install deps/cairo-gobject-*.gem

      - name: Build pango
        shell: msys2 {0}
        run: |
          # Add gobject-introspection include path (pango includes GI headers that need girepository.h)
          export CFLAGS="$CFLAGS $(pkg-config --cflags gobject-introspection-1.0)"
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('pango')"
        env:
          BINARY_GEM: 'true'

      - name: Upload pango extensions
        uses: actions/upload-artifact@v4
        with:
          name: pango-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/pango/lib/
            gems/pango/vendor/
            gems/pango/ext/
          retention-days: 30

  consolidate-pango:
    name: Consolidate pango (x64)
    runs-on: windows-latest
    needs: [build-pango-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download pango extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: pango-extensions-x64-3.3
          path: gems/pango/

      - name: Download pango extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: pango-extensions-x64-3.4
          path: gems/pango/

      - name: Download pango extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: pango-extensions-x64-4.0
          path: gems/pango/

      - name: Build consolidated pango gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('pango')"

      - name: Upload pango gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-pango-x64-mingw32
          path: pkg/pango-*.gem
          retention-days: 90

  # ============================================================================
  # GDK_PIXBUF2 - Depends on glib2
  # ============================================================================

  build-gdk-pixbuf2-x64:
    name: Build gdk_pixbuf2 (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-gobject-introspection]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem

      - name: Build gdk_pixbuf2
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('gdk_pixbuf2')"
        env:
          BINARY_GEM: 'true'

      - name: Upload gdk_pixbuf2 extensions
        uses: actions/upload-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/gdk_pixbuf2/lib/
            gems/gdk_pixbuf2/vendor/
            gems/gdk_pixbuf2/ext/
          retention-days: 30

  consolidate-gdk-pixbuf2:
    name: Consolidate gdk_pixbuf2 (x64)
    runs-on: windows-latest
    needs: [build-gdk-pixbuf2-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download gdk_pixbuf2 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-3.3
          path: gems/gdk_pixbuf2/

      - name: Download gdk_pixbuf2 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-3.4
          path: gems/gdk_pixbuf2/

      - name: Download gdk_pixbuf2 extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-4.0
          path: gems/gdk_pixbuf2/

      - name: Build consolidated gdk_pixbuf2 gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('gdk_pixbuf2')"

      - name: Upload gdk_pixbuf2 gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-gdk_pixbuf2-x64-mingw32
          path: pkg/gdk_pixbuf2-*.gem
          retention-days: 90

  # ============================================================================
  # ATK - Depends on glib2
  # ============================================================================

  build-atk-x64:
    name: Build atk (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-gobject-introspection]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-atk
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem

      - name: Build atk
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('atk')"
        env:
          BINARY_GEM: 'true'

      - name: Upload atk extensions
        uses: actions/upload-artifact@v4
        with:
          name: atk-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/atk/lib/
            gems/atk/vendor/
            gems/atk/ext/
          retention-days: 30

  consolidate-atk:
    name: Consolidate atk (x64)
    runs-on: windows-latest
    needs: [build-atk-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download atk extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: atk-extensions-x64-3.3
          path: gems/atk/

      - name: Download atk extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: atk-extensions-x64-3.4
          path: gems/atk/

      - name: Download atk extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: atk-extensions-x64-4.0
          path: gems/atk/

      - name: Build consolidated atk gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('atk')"

      - name: Upload atk gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-atk-x64-mingw32
          path: pkg/atk-*.gem
          retention-days: 90

  # ============================================================================
  # GDK3 - Depends on pango, gdk_pixbuf2, cairo, glib2
  # ============================================================================

  build-gdk3-x64:
    name: Build gdk3 (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-pango, consolidate-gdk-pixbuf2]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Download gio2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gio2-extensions-x64-${{ matrix.ruby }}
          path: gems/gio2

      - name: Download cairo ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo

      - name: Download cairo-gobject ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo-gobject

      - name: Download pango ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: pango-extensions-x64-${{ matrix.ruby }}
          path: gems/pango

      - name: Download gdk_pixbuf2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-${{ matrix.ruby }}
          path: gems/gdk_pixbuf2

      # Copy .so files for gems with native extensions only
      # GI-only gems (gdk_pixbuf2, atk, gdk3) don't have .so files
      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/
          mkdir -p gems/gio2/ext/gio2
          cp gems/gio2/lib/gio2/*/gio2.so gems/gio2/ext/gio2/
          mkdir -p gems/cairo/ext/cairo
          cp gems/cairo/lib/cairo/*/cairo.so gems/cairo/ext/cairo/
          # cairo_gobject.so (hyphen→underscore in .so name)
          mkdir -p gems/cairo-gobject/ext/cairo-gobject
          cp gems/cairo-gobject/lib/cairo-gobject/*/cairo_gobject.so gems/cairo-gobject/ext/cairo-gobject/
          mkdir -p gems/pango/ext/pango
          cp gems/pango/lib/pango/*/pango.so gems/pango/ext/pango/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem
          gem install deps/gio2-*.gem
          gem install deps/cairo-*.gem
          gem install deps/cairo-gobject-*.gem
          gem install deps/pango-*.gem
          gem install deps/gdk_pixbuf2-*.gem

      - name: Build gdk3
        shell: msys2 {0}
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('gdk3')"
        env:
          BINARY_GEM: 'true'

      - name: Upload gdk3 extensions
        uses: actions/upload-artifact@v4
        with:
          name: gdk3-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/gdk3/lib/
            gems/gdk3/vendor/
            gems/gdk3/ext/
          retention-days: 30

  consolidate-gdk3:
    name: Consolidate gdk3 (x64)
    runs-on: windows-latest
    needs: [build-gdk3-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download gdk3 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: gdk3-extensions-x64-3.3
          path: gems/gdk3/

      - name: Download gdk3 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: gdk3-extensions-x64-3.4
          path: gems/gdk3/

      - name: Download gdk3 extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: gdk3-extensions-x64-4.0
          path: gems/gdk3/

      - name: Build consolidated gdk3 gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('gdk3')"

      - name: Upload gdk3 gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-gdk3-x64-mingw32
          path: pkg/gdk3-*.gem
          retention-days: 90

  # ============================================================================
  # GTK3 - Depends on gdk3, atk, and all previous gems
  # ============================================================================

  build-gtk3-x64:
    name: Build gtk3 (Windows x64, Ruby ${{ matrix.ruby }})
    runs-on: windows-latest
    needs: [consolidate-gdk3, consolidate-atk]

    strategy:
      matrix:
        ruby: ['3.3', '3.4', '4.0']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby ${{ matrix.ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '${{ matrix.ruby }}'
          bundler-cache: true

      - name: Install MSYS2 (x64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          location: ${{ runner.temp }}/msys2-${{ github.run_id }}
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-gobject-introspection
            mingw-w64-x86_64-cairo
            mingw-w64-x86_64-pango
            mingw-w64-x86_64-gdk-pixbuf2
            mingw-w64-x86_64-atk
            mingw-w64-x86_64-toolchain
            pkg-config

      - name: Download dependency gems
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      # Download each dependency artifact to its correct gems/ path
      - name: Download glib2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: glib2-extensions-x64-${{ matrix.ruby }}
          path: gems/glib2

      - name: Download gobject-introspection ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobject-introspection-extensions-x64-${{ matrix.ruby }}
          path: gems/gobject-introspection

      - name: Download gio2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gio2-extensions-x64-${{ matrix.ruby }}
          path: gems/gio2

      - name: Download cairo ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo

      - name: Download cairo-gobject ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: cairo-gobject-extensions-x64-${{ matrix.ruby }}
          path: gems/cairo-gobject

      - name: Download pango ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: pango-extensions-x64-${{ matrix.ruby }}
          path: gems/pango

      - name: Download gdk_pixbuf2 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gdk_pixbuf2-extensions-x64-${{ matrix.ruby }}
          path: gems/gdk_pixbuf2

      - name: Download atk ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: atk-extensions-x64-${{ matrix.ruby }}
          path: gems/atk

      - name: Download gdk3 ext artifacts
        uses: actions/download-artifact@v4
        with:
          name: gdk3-extensions-x64-${{ matrix.ruby }}
          path: gems/gdk3

      # Copy .so files for gems with native extensions only
      # GI-only gems (gdk_pixbuf2, atk, gdk3, gtk3) don't have .so files
      - name: Copy .so files to expected locations
        shell: msys2 {0}
        run: |
          echo "Copying .so files from lib/ to ext/ for workspace linking..."
          mkdir -p gems/glib2/ext/glib2
          cp gems/glib2/lib/glib2/*/glib2.so gems/glib2/ext/glib2/
          # gobject_introspection.so (hyphen→underscore in .so name)
          mkdir -p gems/gobject-introspection/ext/gobject-introspection
          cp gems/gobject-introspection/lib/gobject-introspection/*/gobject_introspection.so gems/gobject-introspection/ext/gobject-introspection/
          mkdir -p gems/gio2/ext/gio2
          cp gems/gio2/lib/gio2/*/gio2.so gems/gio2/ext/gio2/
          mkdir -p gems/cairo/ext/cairo
          cp gems/cairo/lib/cairo/*/cairo.so gems/cairo/ext/cairo/
          # cairo_gobject.so (hyphen→underscore in .so name)
          mkdir -p gems/cairo-gobject/ext/cairo-gobject
          cp gems/cairo-gobject/lib/cairo-gobject/*/cairo_gobject.so gems/cairo-gobject/ext/cairo-gobject/
          mkdir -p gems/pango/ext/pango
          cp gems/pango/lib/pango/*/pango.so gems/pango/ext/pango/

      # Create rcairo directory for check_cairo function in mkmf-gnome.rb
      # The check_cairo helper looks for cairo at top_dir/../rcairo/ (sibling dir)
      # but our structure has gems/cairo/. Use copy (not symlink) because Windows
      # native linker (ld.exe) doesn't follow MSYS2 symlinks.
      - name: Create rcairo copy for cairo headers and linking
        shell: msys2 {0}
        run: |
          echo "Creating rcairo copy for check_cairo and Windows linker..."
          cp -r gems/cairo rcairo
          ls -la rcairo/ext/cairo/

      - name: Install dependencies
        shell: msys2 {0}
        run: |
          gem install deps/glib2-*.gem
          gem install deps/gobject-introspection-*.gem
          gem install deps/gio2-*.gem
          gem install deps/cairo-*.gem
          gem install deps/cairo-gobject-*.gem
          gem install deps/pango-*.gem
          gem install deps/gdk_pixbuf2-*.gem
          gem install deps/atk-*.gem
          gem install deps/gdk3-*.gem

      - name: Build gtk3
        shell: msys2 {0}
        run: |
          # Add gobject-introspection include path (gtk3 includes GI headers that need girepository.h)
          export CFLAGS="$CFLAGS $(pkg-config --cflags gobject-introspection-1.0)"
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:gem'].invoke('gtk3')"
        env:
          BINARY_GEM: 'true'

      - name: Upload gtk3 extensions
        uses: actions/upload-artifact@v4
        with:
          name: gtk3-extensions-x64-${{ matrix.ruby }}
          path: |
            gems/gtk3/lib/
            gems/gtk3/vendor/
            gems/gtk3/ext/
          retention-days: 30

  consolidate-gtk3:
    name: Consolidate gtk3 (x64)
    runs-on: windows-latest
    needs: [build-gtk3-x64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Download gtk3 extensions (Ruby 3.3)
        uses: actions/download-artifact@v4
        with:
          name: gtk3-extensions-x64-3.3
          path: gems/gtk3/

      - name: Download gtk3 extensions (Ruby 3.4)
        uses: actions/download-artifact@v4
        with:
          name: gtk3-extensions-x64-3.4
          path: gems/gtk3/

      - name: Download gtk3 extensions (Ruby 4.0)
        uses: actions/download-artifact@v4
        with:
          name: gtk3-extensions-x64-4.0
          path: gems/gtk3/

      - name: Build consolidated gtk3 gem
        run: |
          bundle exec ruby -I. -e "require 'rake'; Rake.application.load_rakefile; Rake::Task['build:consolidate_gem'].invoke('gtk3')"

      - name: Upload gtk3 gem
        uses: actions/upload-artifact@v4
        with:
          name: gem-gtk3-x64-mingw32
          path: pkg/gtk3-*.gem
          retention-days: 90

  # ============================================================================
  # DLL DISTRIBUTION DISCOVERY - Analyze complete suite for DLL allocation
  # ============================================================================

  discover-dll-distribution:
    name: Discover DLL Distribution
    runs-on: windows-latest
    if: always()  # Run even if some builds fail
    needs: [consolidate-glib2, consolidate-gobject-introspection, consolidate-gio2,
            consolidate-cairo, consolidate-cairo-gobject, consolidate-pango,
            consolidate-gdk-pixbuf2, consolidate-atk, consolidate-gdk3, consolidate-gtk3]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby 3.3
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      # Note: windows-latest already has MSYS2 installed with objdump available
      # No need to install MSYS2 again (causes conflict)

      - name: Download all gem artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gem-*-x64-mingw32
          path: deps/
          merge-multiple: true

      - name: Download all extension artifacts (Ruby 3.3)
        uses: actions/download-artifact@v4
        continue-on-error: true  # Some may not exist if builds failed
        with:
          pattern: '*-extensions-x64-3.3'
          path: .
          merge-multiple: true

      - name: Verify .so files exist
        shell: bash
        run: |
          echo "Checking for compiled .so files..."
          find gems -name "*.so" -type f | head -20 || echo "No .so files found"

      - name: Run DLL distribution discovery
        shell: bash
        run: |
          echo "Running DLL distribution analysis..."
          # Add MSYS2 to PATH for objdump
          export PATH="/c/msys64/ucrt64/bin:$PATH"
          ruby scripts/discover-dll-distribution.rb > dll-distribution.json 2>analysis.log || {
            echo "Discovery script failed, showing logs:"
            cat analysis.log
            echo "Continuing anyway to upload partial results..."
          }

      - name: Display discovery summary
        if: always()
        shell: bash
        run: |
          echo "=== DLL Distribution Discovery Results ==="
          if [ -f analysis.log ]; then
            tail -30 analysis.log
          fi
          echo ""
          if [ -f dll-distribution.json ]; then
            echo "=== Distribution Summary ==="
            ruby -rjson -e 'data=JSON.parse(File.read("dll-distribution.json")); data["distribution"].each{|g,d| puts "  #{g}: #{d.count} DLLs"}' || echo "Failed to parse JSON"
          else
            echo "No dll-distribution.json generated"
          fi

      - name: Upload discovery results
        uses: actions/upload-artifact@v4
        with:
          name: dll-distribution-analysis
          path: |
            dll-distribution.json
            analysis.log
          retention-days: 90
